Metadata-Version: 2.4
Name: karospace-export
Version: 0.1.0
Summary: Static HTML exporter for AnnData (.h5ad) datasets
Author: KaroSpace Builder
License: MIT
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: anndata>=0.10
Requires-Dist: numpy>=1.24
Requires-Dist: pandas>=2.0
Requires-Dist: scipy>=1.10
Requires-Dist: Pillow>=10.0
Provides-Extra: dev
Requires-Dist: pytest>=8.0; extra == "dev"

# karospace-export

Export an AnnData `.h5ad` into a fully static KaroSpace-compatible viewer bundle.

The export works without any backend server and can be opened from static hosting (Cloudflare Pages/R2) or locally.

## What You Get

Output directory structure:

```text
export_dir/
  index.html
  manifest.json
  preview.png                  # optional
  assets/
    obs_000.csv.gz
    obs_records_000.json.gz
    var_000.csv.gz
    coords_000.json.gz
    image.png                  # optional
    expression/
      gene_00000_part_000.bin.gz
      gene_00001_part_000.bin.gz
      ...
```

Key files:

- `index.html`: minimal canvas-based viewer.
- `manifest.json`: schema + asset inventory.
- `assets/`: metadata, coordinates, optional image, and exported gene expression chunks.

## Quick Start (GUI App)

### 1) Create a GUI-capable environment

If your current Python lacks `_tkinter`, use this:

```bash
conda create -n ks-gui -c conda-forge python=3.12 pip tk python.app anndata numpy pandas scipy pillow
conda activate ks-gui
```

### 2) Install this project

```bash
cd /Users/christoffer/work/karolinska/development/karospace-builder
pip install -e .
```

### 3) Launch app

```bash
karospace-export-app
```

If the command is not found, run:

```bash
python -m karospace_export.app
```

GUI features:

- File pickers for input/output/image/gene-list paths.
- Controls for coordinate source, annotations, gene mode, downsampling, gzip, and asset chunk size.
- Background export with logs.
- Optional local preview server.

## Quick Start (CLI)

```bash
karospace-export \
  --h5ad /absolute/path/to/input.h5ad \
  --outdir /absolute/path/to/export \
  --anno cell_type \
  --anno leiden \
  --genes hvgs:500 \
  --gzip true \
  --max-asset-mb 16
```

Optional local serving:

```bash
karospace-export \
  --h5ad /absolute/path/to/input.h5ad \
  --outdir /absolute/path/to/export \
  --anno cell_type \
  --genes top_mean:300 \
  --serve \
  --port 8000
```

## CLI Arguments

- `--h5ad PATH` required.
- `--outdir PATH` required.
- `--coords {obsm:spatial,obs:centroid_x_y}` optional (auto-detect if omitted).
- `--anno COLNAME` repeatable.
- `--genes MODE` where mode is `hvgs:N`, `top_mean:N`, or `list:PATH`.
- `--image PATH` optional.
- `--downsample N` optional.
- `--gzip true/false` default `true`.
- `--max-asset-mb NUMBER` default `16`.
- `--serve` optional preview server.
- `--port` optional server port (default `8000`).
- `--no-preview` disable `preview.png`.

## Input Assumptions

Expected in `.h5ad`:

- `adata.obs` with annotation columns.
- Coordinates from `adata.obsm["spatial"]` or `obs` columns `centroid_x` and `centroid_y`.
- Optional tissue image from `adata.uns["spatial"]` or `--image PATH`.

## Export Format

`manifest.json` includes:

- `dataset_name`
- `n_cells`
- `n_genes_exported`
- `coordinate_source`
- `annotation_columns`
- `gene_list`
- `asset_files`
- `expression`
- `schema_version`
- optional `image`
- optional `preview_path`

Expression is stored as per-gene `float32` vectors in chunked binary files (`per_gene_float32_v1`) so the browser can lazy-load one gene at a time.

## Viewer Behavior

`index.html` is dependency-light and supports:

- Fast point rendering in canvas.
- Color by annotation or selected gene expression.
- Hover tooltip with `obs` fields.
- Category filter.
- Point size and opacity controls.

On strict `file://` browser policies, the viewer can prompt for folder access and read assets via File API.

## Python API

```python
from pathlib import Path
from karospace_export import ExportConfig, export_h5ad

manifest = export_h5ad(
    ExportConfig(
        h5ad_path=Path("input.h5ad"),
        outdir=Path("export"),
        genes_mode="top_mean:300",
        annotation_columns=["cell_type", "leiden"],
    )
)
```

## Example Dataset

Generate a tiny synthetic `.h5ad`:

```bash
python /Users/christoffer/work/karolinska/development/karospace-builder/examples/generate_synthetic_h5ad.py
```

## Troubleshooting

### `No module named '_tkinter'`

Your Python build does not include Tkinter. Use a dedicated Conda environment with `python=3.12` and `tk`:

```bash
conda create -n ks-gui -c conda-forge python=3.12 pip tk python.app anndata numpy pandas scipy pillow
conda activate ks-gui
pip install -e /Users/christoffer/work/karolinska/development/karospace-builder
karospace-export-app
```

### `karospace-export-app` not found

Reinstall in the active environment:

```bash
pip install -e /Users/christoffer/work/karolinska/development/karospace-builder
```

Then run either:

```bash
karospace-export-app
```

or:

```bash
python -m karospace_export.app
```

## Development

Run tests:

```bash
python -m pytest -q
```
